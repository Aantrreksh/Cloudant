---

copyright:
  years: 2017
lastupdated: "2017-07-11"

---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:screen: .screen}
{:codeblock: .codeblock}
{:pre: .pre}

<!-- Acrolinx: 2017-05-10 -->

# 災害復旧およびバックアップ

データは重要であり貴重です。お客様はデータを保護して、データの安全性、可用性、および保全性の維持の確保に役立てたいと考えます。Cloudant には、お客様のデータを保護し、アプリケーションを稼働させ続けるうえで役立ついくつかの方法が用意されています。
{:shortdesc}

これらの保護機能のいくつかは自動機能です。他の形式の保護について、Cloudant では、お客様独自の高可用性機能および災害復旧機能の作成に役立つサポート対象ツールを用意しています。

本書では、Cloudant で提供されている自動機能とサポート対象ツールの概要を提供します。

## 保護のタイプとレベル

必要な保護のタイプは、解決しようとしている問題によって決まります。

例えば、システム内の限られた量のハードウェアで障害が発生してもデータにアクセスできるように、ハイレベルのデータ可用性を持ちたい場合があります。これは、「高可用性」(HA) 要件です。これは、ハードウェア障害の発生後、考えられる最良の継続的データ可用性を提供することを意味します。HA の手法が異なれば、操作に影響が及ぶことなく許容できる障害のレベルも異なります。

あるいは、簡単および素早い方法でデータのバックアップとリストアを行いたいと考える場合があります。例えば、重大または広範囲に及ぶハードウェア障害の後に、できるだけ迅速に代替システムでデータを使用可能にしたい場合があります。これは、「災害復旧」(DR) 要件です。災害とは一般的に、データベースが 1 つ以上の場所でもはや使用できないことを意味します。例えば、電源異常により、データベース・クラスター内の全システムで障害が発生する場合があります。あるいは、大規模なネットワーク障害は、クラスター内のシステムが正常に機能し続けていても、それらに接続できないことを意味する場合があります。

HA 要件または DR 要件の対処は、多くの場合、もっと一般的な要件に問題を単純化することから開始します。要件を特定したら、一般的なニーズの解決に役立つツールと機能を適用することができます。ツールと機能を組み合わせることにより、HA 要件または DR 要件の対処が可能になります。

>	**注**: ツールおよび機能が異なれば、提供される保護のレベルも異なります。さまざまな機能は、ユーザーの特定の HA 要件または DR 要件に多かれ少なかれ適している可能性があります。

Cloudant には、以下のように一般的な要件に対処する数多くのツールおよび機能が用意されています。

1.	単一リージョン内でのデータの冗長性。[リージョン内自動データ冗長性](#in-region-automatic-data-redundancy)とも呼ばれます。
2.	クロスリージョンのデータの冗長性およびフェイルオーバー。[災害復旧のためのクロスリージョン冗長性](#cross-region-redundancy-for-disaster-recovery)とも呼ばれます。
3.	「従来型の」[データベースのバックアップおよびリカバリー](#database-backup-and-recovery)を使用した、ポイント・イン・タイム・リストアのためのポイント・イン・タイム・スナップショット・バックアップ。

## リージョン内自動データ冗長性

単一の Cloudant アカウント内で、データは内部プロセスと自動プロセスを使用して三重に保管されます。ユーザーは、この内部データ複製を使用可能にするために何もする必要はありません。

リージョン内データ冗長性は、高可用性保護を有効にします。具体的には、リージョン内データ冗長性は、リージョン内でのハードウェア障害に対するデータの保護を提供します。リージョン内のハードウェア装置で障害が発生すると、その装置に保管されているデータのコピーだけが使用不可になります。Cloudant が、リージョン内の他のハードウェア装置でまだ使用可能なデータのコピーに要求を経路指定するため、アプリケーションは使用可能なままになります。その一方で、システムの自動モニタリングがハードウェア装置の障害を検出し、完全冗長性のアクションおよびその後の修復を要求します。

Cloudant アカウントは、単一リージョン内に配置されています。この特性は、アカウント内に保管しているすべてのデータが、それぞれその単一リージョン内でホストされている別個の複数サーバーにわたって保管されていることを意味します。

リージョン内自動データ冗長性には、以下のような制限があります。

1.	単一リージョン内のみで保護を提供する。
2.	現行データを維持する。

アカウントに関連付けられている単一リージョンを超えて保護を提供するには、[災害復旧のためのクロスリージョン冗長性](#cross-region-redundancy-for-disaster-recovery)を使用します。

データの「履歴」に対して保護を提供する (例えば、アプリケーションがデータに対して行う変更の監査を使用可能にする) には、[データベースのバックアップおよびリカバリー](#database-backup-and-recovery)・ツールによって作成されるデータ・スナップショットを使用します。

要約すると、リージョン内データ冗長性は、リージョン内の単一システムに影響を与える障害に対する許容度を提供することにより、高可用性機能を使用可能にします。

## 災害復旧のためのクロスリージョン冗長性

Cloudant の複製機能は、柔軟な災害復旧機能をアプリケーションに組み込むのに役立ちます。災害復旧を使用可能にするための主な方法は、Cloudant 複製を使用して、複数のリージョンにわたる冗長性を作成するというものです。この結果として、アプリケーションは、1 つ以上のリージョンが使用不可になるというシチュエーションを容認することができます。

クロスリージョン冗長性の作成の基本ステップは以下のとおりです。

1.  2 つ以上のリージョンに Cloudant アカウントを作成する。
2.  必要に応じて各リージョンにデータベースを作成する。
3.  クロスリージョン冗長性を使用して保管する必要があるデータベースについては、各アカウント内の対応するデータベース間の継続的双方向複製をセットアップする。
4.  ユーザーの環境が「アクティブ - パッシブ」構成か、または「アクティブ - アクティブ」構成かに応じてデータが経路指定されるように、アプリケーションを設計および実装する。これをセットアップするための詳細なガイドが[使用可能](active-active.html)です。

複数のリージョンにわたるデータを処理するようアプリケーションを設計する場合は、以下の点を考慮してください。

* アプリケーションは、それらの物理的位置に最も近い場所でホストされているデータベースに要求を送信することができます。この隣接性の使用により、ネットワーク待ち時間を削減し、応答時間を改善できます。この構成は、「アクティブ - アクティブ」方式と呼ばれます。これは、データの複数コピーの同時使用によって特徴付けられています。「アクティブ - アクティブ」構成内で機能するアプリケーションは、複数のデータ・コピーに関する問題を回避するために、[競合を処理するための戦略](mvcc.html#distributed-databases-and-conflicts)を持つ必要があります。
* デフォルトで、アプリケーションは単一リージョンからデータを要求できます。そのリージョンが使用可能でない場合、アプリケーションは別のリージョンからデータを要求するよう切り替えることができます。この構成は、「アクティブ - パッシブ」方式と呼ばれます。これは、1 度に 1 つのデータ・セットのみのアクティブ使用によって特徴付けられています。
* アプリケーションはハイブリッド構成を使用する場合があります。ハイブリッド構成では、すべてのデータ書き込み要求には単一のアカウントが使用され、他の場所は読み取り専用の要求のみに使用されます。この構成は、読み取りについて「アクティブ - アクティブ」と見なされます。
* 災害シナリオでは、まだ接続されているリージョン内でホストされているアカウントにアクセスするために、アプリケーションはデータ要求を再経路指定する必要があります。この要件は、アプリケーションがリージョンの消失を検出し、次にデータ要求を再経路指定できる必要があることを意味します。

要約すると、クロスリージョン冗長性は、高可用性機能に似ていますが、リージョン全体に影響を与える障害に適用されます。しかし、クロスリージョン冗長性構成で正しく機能するようアプリケーションを構成することで、真の災害復旧機能が提供されます。この理由は、あるリージョン内のデータが一定期間使用不可になった場合でも、アプリケーションは機能し続けることができるからです。Cloudant 複製は、リージョン間のデータ同期化を確保するために役立ちます。ただし、アプリケーションは、他のリージョンに保管されているデータのコピーに「フェイルオーバー」できる必要があります。

## データベースのバックアップとリカバリー

[リージョン内自動データ冗長性](#in-region-automatic-data-redundancy)は、データへの高可用性アクセスをアプリケーションに提供します。[災害復旧のためにクロスリージョン冗長性](#cross-region-redundancy-for-disaster-recovery)は、災害からの復旧手段をアプリケーションに提供します。しかし、これらの機能は両方とも、データの_現行_コピーのみへのアクセスの維持に焦点を当てています。

実際には、人間およびアプリケーションは、間違いをすることがあり、意図しない方法でデータを変更してしまう可能性があります。アプリケーション自体は何らかの保護を実装できますが、時折、望ましくない変更が行われてしまうことがあります。この場合、前のポイント・イン・タイムからデータを復元できると有用です。データベースのバックアップは、この要件をサポートします。

高可用性機能と災害復旧機能によってデータを保護することに加え、一定間隔で周期的にデータベース・データを別の場所にダンプすることを検討してください。バックアップが完全であり正常であるということの信頼性のために、必ずバックアップを検査およびテストするようにしてください。

Cloudant は、データベース内の JSON 内容をファイルにダンプし、後でそれらのファイルからデータベースをリストアするのに役立つツールをサポートしています。

具体的には、Cloudant でサポートされているツールは以下のことに役立ちます。

*	完全なデータベースを、さらなる処理およびオフサイト・ストレージに適したファイルにバックアップする。
*	バックアップ・ファイルに含まれている前の状態から完全なデータベースをリストアする。

<strong style="color:red;">警告</strong> Cloudant でサポートされているツールには以下の制限があります。 

*	`_security` の設定は、ツールによってバックアップされません。
*	添付ファイルは、ツールによってバックアップされません。
*	バックアップは、正確な「ポイント・イン・タイム」のスナップショットではありません。これは、データベース内の文書がバッチで取得され、同じときに他のアプリケーションが文書を更新している可能性があるためです。従って、データベース内のデータは、最初のバッチが読み取られたときと最後のバッチが読み取られたときで異なる可能性があります。
*	索引定義が保持する設計文書はバックアップされるが、データがリストアされる時、索引は再作成しなければならない。リストアされるデータの量に応じて、この再作成にはかなりの時間がかかる可能性があります。

<div id="conclusion"></div>

## 次のステップ

基本的な Cloudant 機能およびサポート対象ツールで構築されるアプリケーションを開発して、もっと複雑なデータ保護戦略を可能にすることができます。

サンプル・シナリオを以下に示します。

*	前の状態から単一文書をリストアする。
*	以前の文書状態を複数保管して、かなり以前からのリストアを可能にする。
*	保存のコスト効率を上げるために、古いデータを安価なストレージにマイグレーションする。

バックアップ・ツールは、オープン・ソースの node.js コマンド・ライン・アプリケーションとライブラリーで構成されています。[NPM ![外部リンク・アイコン](../images/launch-glyph.svg "外部リンク・アイコン")](https://www.npmjs.com/package/@cloudant/couchbackup){:new_window} から入手可能です。

データ保護戦略へのツールの組み込み方法を示すアイデアと例については、[バックアップのクックブック・ガイド](backup-cookbook.html)を参照してください。
